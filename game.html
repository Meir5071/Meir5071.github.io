<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>PPE</title>

    <style>
        .grid {
            display: flex;
            flex-wrap: wrap;
            border-style: solid;
        }
    </style>
</head>

<body>
    <h1>Purple People Eaters
    </h1>
    <h3>Use the arrows to move, do not let the monsters get to you. Lock the monsters using the boxes. Press "p" to
        pause. Press "s" to turn on and of the sound.</h3>
    <h4 id="timer">Time: 00:00</h4>
    <div class="grid">
    </div>
    <button id="back">Back to settings</button>
    <button id="restart">Restart</button>
    <h2 class="win_lose"></h2>
    <h1 class="pause"></h1>
    <h3 class="contin"></h3>
    <script>
        //list all card options

        const grid = document.querySelector('.grid')
        const win_lose = document.querySelector('.win_lose')
        const pause_lable = document.querySelector('.pause')
        const contin = document.querySelector('.contin')
        const time = document.getElementById("timer")
        const back_b = document.getElementById('back')
        const restart = document.getElementById('restart')
        back_b.addEventListener("click",go_back)
        restart.addEventListener("click",restart_fun)
        const squre_size = Number(localStorage.getItem("squre_size"))
        //console.log(localStorage.getItem("squre_size"))
        const n_of_rows = Number(localStorage.getItem("n_of_rows"))
        const n_of_columns = Number(localStorage.getItem("n_of_columns"))
        const monster_slownes = 1000 / Number(localStorage.getItem("monster_speed"))
        const n_of_monsters = Number(localStorage.getItem("n_of_monsters"))
        const present_of_boxes = Number(localStorage.getItem("present_of_boxes")) / 100
        const prob_mult_p = Number(localStorage.getItem("prob_mult_p"))
        const prob_mult_b = Number(localStorage.getItem("prob_mult_b"))
        let sound = false
        let monster_sound = new Audio('sounds/monster.mp3')
        let player_sound = new Audio('sounds/Player.mp3')
        monster_sound.volume = 0.2
        player_sound.volume = 0.2
        //monster_sound.play()
        //console.log(localStorage.getItem("allow_player_diagonls"))
        //console.log(localStorage.getItem("allow_monster_diagonls"))
        //console.log(localStorage.getItem("allow_monster_diagonls")=="true")
        let allow_player_diagonls
        let allow_monster_diagonls

        if (localStorage.getItem("allow_player_diagonls") == "true") { allow_player_diagonls = true }
        else { allow_player_diagonls = false }
        if (localStorage.getItem("allow_monster_diagonls") == "true") { allow_monster_diagonls = true }
        else { allow_monster_diagonls = false }
        const dirs = init_dirs()
        let board = []
        let player_pos = [Math.floor(n_of_rows / 2), Math.floor(n_of_columns / 2)]
        //console.log([10,20]===player_pos)
        let map = init_map()
        //console.log(map)
        let monsters = init_monsters()
        let timerId
        let timer_time
        display_map()
        let time_sec_1 = 0
        let time_sec_10 = 0
        let time_min_1 = 0
        let time_min_10 = 0
        //move_monsters()
        //test_cumsum()
        //test_weighted_random_choice()
        document.addEventListener('keydown', players_move)
        //grid.addEventListener('keydown',players_move)
        timerId = setInterval(move_monsters, monster_slownes)
        timer_time = setInterval(timer, 1000)
        //a = setInterval(tmp, 10000)
        //function play_monster(){monster_sound.play()}

        function timer() {
            time_sec_1++
            if (time_sec_1 == 10) {
                time_sec_1 = 0
                time_sec_10++
                if (time_sec_10 == 6) {
                    time_sec_10 = 0
                    time_min_1++
                    if (time_min_1 == 10) {
                        time_min_1 = 0
                        time_min_10++
                        if (time_min_10 == 10) {
                            time_min_10 = 0
                        }
                    }
                }
            }
            time.innerHTML = "Time: ".concat((time_min_10.toString()), (time_min_1.toString()), ":", (time_sec_10.toString()), (time_sec_1.toString()))
        }
        function init_dirs() {
            if (!(allow_monster_diagonls)) {
                return [[1, 0], [0, 1], [0, -1], [-1, 0]]
            }
            else { return [[1, 0], [0, 1], [0, -1], [-1, 0], [1, 1], [1, -1], [-1, -1], [-1, 1]] }
        }

        function init_map() {
            let new_map = []
            for (let i = 0; i < n_of_rows; i++) {
                new_map.push([])
                for (let j = 0; j < n_of_columns; j++) {
                    if ([i, j].toString() == player_pos.toString()) { new_map[i].push(3) }
                    else {
                        if (Math.random() < present_of_boxes) {
                            new_map[i].push(1)
                        }
                        else { new_map[i].push(0) }
                    }
                }
            }
            return new_map
        }

        function init_monsters() {
            let new_monsters = []
            let i
            let j
            while (new_monsters.length < n_of_monsters) {
                i = randomInt(n_of_rows)
                j = randomInt(n_of_columns)
                if (map[i][j] == 0) {
                    new_monsters.push([i, j])
                    map[i][j] = 2
                }
            }
            return new_monsters
        }
        function display_map() {
            grid.style.width = n_of_columns * squre_size + 'px'
            grid.style.height = n_of_rows * squre_size + 'px'
            for (let i = 0; i < n_of_rows; i++) {
                for (let j = 0; j < n_of_columns; j++) {
                    const squere = document.createElement('img')
                    squere.setAttribute('src', num_to_img(map[i][j]))
                    squere.setAttribute('width', squre_size + 'px')

                    squere.setAttribute('data-id', get_ind(i, j))
                    grid.appendChild(squere)
                    board.push(squere)
                }
            }
        }
        function move_monsters() {
            //console.log("bla")
            let w = true
            if (sound) { monster_sound.play() }
            for (let i = 0; i < n_of_monsters; i++) {
                // console.log(i)
                w = w && is_locked(i)
                move_monster(i)
            }
            //console.log("bla")
            //check_victory()
            if (w) { win() }
        }
        function move_monster(i) {
            let weights = get_wheights(i)
            //console.log(weights)
            let dir = weighted_random_choice(dirs, weights)
            //console.log(i)
            move_monster_dir(i, dir)
        }
        function get_wheights(ind) {
            let weights = []
            for (let i = 0; i < dirs.length; i++) {
                //console.log(1>2)
                if (norm2(dif(player_pos, monsters[ind])) > norm2(dif(player_pos, sum(monsters[ind], dirs[i])))) {
                    //console.log("bla")
                    weights.push(prob_mult_p)
                }
                else { weights.push(1) }
                let loc = sum(monsters[ind], dirs[i])
                if (!(is_free(loc[0], loc[1]))) {
                    weights[i] = prob_mult_b * weights[i]
                }
            }
            //console.log(weights)
            //console.log(dirs)
            return weights
        }
        function players_move(e) {
            if (sound) { player_sound.play() }
            //console.log("bla")
            let dir = key_to_dir(e.key)
            if (dir != undefined) {
                e.preventDefault()
                move_player_dir(dir)
            }
        }
        function get_ind(i, j) { return i * n_of_columns + j }
        function num_to_img(n) {
            switch (n) {
                case 0:
                    return 'images/blank.png';
                case 1:
                    return 'images/box.png';
                case 2:
                    return 'images/monster.png';
                case 3:
                    return 'images/player.png';
            }
        }
        function randomInt(max) {
            return Math.floor(Math.random() * max);
        }
        function weighted_random_choice(ops, weights) {
            let w = cum_sum(weights)
            //console.log(w)
            let r = Math.random() * w[w.length - 1]
            //console.log(r)
            for (let i = 0; i < w.length; i++) {
                if (r <= w[i]) {
                    return ops[i]
                }
            }
        }
        function cum_sum(lis) {
            let sum = [lis[0]]
            for (let i = 1; i < lis.length; i++) {
                sum.push(sum[i - 1] + lis[i])
            }
            return sum
        }
        function move_monster_dir(ind, dir) {
            //console.log(ind)
            //console.log(monsters)
            //console.log(monsters[ind])
            let i = monsters[ind][0] + dir[0]
            let j = monsters[ind][1] + dir[1]
            if (is_inside(i, j)) {
                if (map[i][j] == 3) {
                    //move_to_blank(monsters[ind],[i,j])
                    //monsters[ind]=[i,j]
                    lose()
                }
                if (map[i][j] == 0) {
                    move_to_blank(monsters[ind], [i, j])
                    monsters[ind] = [i, j]
                }
            }
        }
        function is_inside(i, j) {
            //console.log(i)
            //console.log(j)
            return (i > -1) && (i < n_of_rows) && (j > -1) && (j < n_of_columns)
        }
        function set_img(i, j) {
            board[get_ind(i, j)].setAttribute('src', num_to_img(map[i][j]))
        }
        function move_to_blank(from, to) {
            map[to[0]][to[1]] = map[from[0]][from[1]]
            map[from[0]][from[1]] = 0
            set_img(to[0], to[1])
            set_img(from[0], from[1])
        }
        function key_to_dir(key) {
            switch (key) {
                case "ArrowUp":
                    return [-1, 0]
                case "ArrowDown":
                    return [1, 0]
                case "ArrowRight":
                    return [0, 1]
                case "ArrowLeft":
                    return [0, -1]
            }
            if (allow_player_diagonls) {
                switch (key) {
                    case "Home":
                        return [-1, -1]
                    case "End":
                        return [1, -1]
                    case "PageDown":
                        return [1, 1]
                    case "PageUp":
                        return [-1, 1]
                }
            }
            if (key == "p") { pause() }
            if (key == "s") { sound = !(sound) }
        }
        function move_player_dir(dir) {
            player_pos = move_and_push(player_pos, dir, true)
        }
        function move_and_push(from, dir, p) {
            let i = from[0] + dir[0]
            let j = from[1] + dir[1]
            if (is_inside(i, j)) {
                if ((map[i][j] == 2) && p) { lose() }
                if (map[i][j] == 1) { move_and_push([i, j], dir, false) }
                if (map[i][j] == 0) {
                    move_to_blank(from, [i, j])
                    return [i, j]
                }
            }
            return from
        }
        function lose() {
            document.removeEventListener('keydown', players_move)
            clearInterval(timerId)
            clearInterval(timer_time)
            win_lose.innerHTML = "You lost!"
        }
        function is_locked(ind) {
            //console.log("bla")
            let w = true
            for (let i = 0; i < dirs.length; i++) {
                w = w && !(is_free(monsters[ind][0] + dirs[i][0], monsters[ind][1] + dirs[i][1]))
            }
            return w
        }
        function is_free(i, j) {
            //console.log("bla")
            if (is_inside(i, j)) {
                return (map[i][j] != 1) && (map[i][j] != 2)
            }
            //console.log("bla")
            return false
        }
        function win() {
            //console.log("bla")
            document.removeEventListener('keydown', players_move)
            clearInterval(timerId)
            clearInterval(timer_time)
            win_lose.innerHTML = "You won!"
        }
        function sum(a, b) {
            return [a[0] + b[0], a[1] + b[1]]
        }
        function dif(a, b) {
            return [a[0] - b[0], a[1] - b[1]]
        }
        function norm2(a) {
            return a[0] * a[0] + a[1] * a[1]
        }
        function pause() {
            document.removeEventListener('keydown', players_move)
            clearInterval(timerId)
            clearInterval(timer_time)
            pause_lable.innerHTML = "Pause"
            contin.innerHTML = "Press 'p' to continiue"
            document.addEventListener("keydown", stop_pause)
        }
        function stop_pause(e) {
            if (e.key == "p") {
                pause_lable.innerHTML = ""
                contin.innerHTML = ""
                document.removeEventListener("keydown", stop_pause)
                document.addEventListener('keydown', players_move)
                timerId = setInterval(move_monsters, monster_slownes)
                timer_time = setInterval(timer, 1000)
            }
        }

        //tests

        function test_weighted_random_choice() {
            for (let i = 0; i < 100; i++) {
                console.log(weighted_random_choice([0, 1, 2], [1, 1, 20]))
            }
        }
        function test_cumsum() {
            console.log(cum_sum([0, 1, 2, 3, 4, 5]))
        }
        function go_back(e) {
            history.back()
        }
        function restart_fun(e) {
            window.location.href = "game.html";
        }



  //const resultDisplay = document.querySelector('#result')
  //let cardsChosen = []
  //let cardsChosenId = []
  //let cardsWon = []

  //create your board
  //function createBoard() {
  //  for (let i = 0; i < cardArray.length; i++) {
  //    const card = document.createElement('img')
  //    card.setAttribute('src', 'images/monster.png')
  //    card.setAttribute('width', '50')
  //    //card.setAttribute('height', '50')
  //
  //    card.setAttribute('data-id', i)
  //    //card.addEventListener('click', flipCard)
  //    grid.appendChild(card)
  //  }
  //}
  //createBoard()

  //check for matches
  //function checkForMatch() {
  //  const cards = document.querySelectorAll('img')
  //  const optionOneId = cardsChosenId[0]
  //  const optionTwoId = cardsChosenId[1]
  //
  //  if(optionOneId == optionTwoId) {
  //    cards[optionOneId].setAttribute('src', 'images/blank.png')
  //    cards[optionTwoId].setAttribute('src', 'images/blank.png')
  //    alert('You have clicked the same image!')
  //  }
  //  else if (cardsChosen[0] === cardsChosen[1]) {
  //    alert('You found a match')
  //    cards[optionOneId].setAttribute('src', 'images/white.png')
  //    cards[optionTwoId].setAttribute('src', 'images/white.png')
  //    cards[optionOneId].removeEventListener('click', flipCard)
  //    cards[optionTwoId].removeEventListener('click', flipCard)
  //    cardsWon.push(cardsChosen)
  //  } else {
  //    cards[optionOneId].setAttribute('src', 'images/blank.png')
  //    cards[optionTwoId].setAttribute('src', 'images/blank.png')
  //    alert('Sorry, try again')
  //  }
  //  cardsChosen = []
  //  cardsChosenId = []
  //  resultDisplay.textContent = cardsWon.length
  //  if  (cardsWon.length === cardArray.length/2) {
  //    resultDisplay.textContent = 'Congratulations! You found them all!'
  //  }
  //}

  //flip your card
  //function flipCard() {
  //  let cardId = this.getAttribute('data-id')
  //  cardsChosen.push(cardArray[cardId].name)
  //  cardsChosenId.push(cardId)
  //  this.setAttribute('src', cardArray[cardId].img)
  //  if (cardsChosen.length ===2) {
  //    setTimeout(checkForMatch, 500)
  //  }
  //}


    </script>

</body>

</html>